:
# Run by "didactic-cl build"

vecho "Running docker-cibuild --metadata=${IMAGE_METADATA} $@"
docker-cibuild --metadata=${IMAGE_METADATA} "$@" || exit 1

if truthy "${CITOOLS_VERBOSE}" ; then
    vecho "IMAGE_METADATA=${IMAGE_METADATA}:"
    sed -e 's/^/    /' "${IMAGE_METADATA}" >&2
fi
# Following . command will set IMAGE_TAG and other vars
. ${IMAGE_METADATA} || exit 1

if [ ":${IMAGE_TAG}" = ":" ] ; then
    echo "${PROG}: unable to retrieve new image tag!" >&2
    exit 1
fi
export IMAGE_TAG
circle-env --add IMAGE_TAG

if [ ":${DOCKER_LOGIN}" = ":" ] ; then
    echo "${PROG}: Unable to login to docker registry: no credentials" >&2
    exit 1
fi

vecho "Running \"docker logout\""
docker logout
vecho "Running \"docker login <${DOCKER_LOGIN_TYPE}_login_args>...\""
eval ${DOCKER_LOGIN} || exit 1

vecho "Running \"docker push ${IMAGE_NAME}\""
docker push "${IMAGE_NAME}" || exit 1

vecho "Running \"${DIDACTIC_REGISTER_IMAGE_CMD}\""
eval ${DIDACTIC_REGISTER_IMAGE_CMD} || exit 1

exit 0




